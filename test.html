<!doctype html>
<title>JS2ME</title>
<script type="text/javascript" src="js/zip/zip.js"></script>
<script type="text/javascript" src="js/zip/inflate.js"></script>
<script type="text/javascript" src="js/zip/zip-ext.js"></script>
<script type="text/javascript">
	window.onload = function () {
		zip.useWebWorkers = false;
		zip.workerScriptsPath = 'js/zip/';
		var reader = new zip.HttpReader('FPC_Bench_3.jar');
		//var reader = new zip.HttpReader('jars/asteroids.jar');
		//var reader = new zip.HttpReader('out/form.jar');
		
		function loadClasses(classes, callback) {
			var remain = 0;
			if (classes.constructor == Array) {
				var array = classes;
				classes = {};
				for (var i in array) {
					classes[array[i]] = true;
				}
			}
			for (var className in classes) {
				try {
					js2me.findClass(className);
				} catch (e) {
					(function (className) {
						//console.log(className);
						remain++;
						var classPath = className.replace(js2me.JAVA_ROOT, 'js/me').replace(/\$/g, '').replace(/\./g, '/') + '.js';
						var element = document.createElement('script');
						element.src = classPath;
						element.onload = function () {
							if (js2me.classBucket == null) {
								throw new javaRoot.$java.$lang.$ClassNotFoundException(className + ' not found');
							}
							var proto = js2me.classBucket.prototype;
							var splitPoint = className.lastIndexOf('.');
							proto.package = className.substring(0, splitPoint);
							proto.name = className.substring(splitPoint + 1);
							var package = js2me.findPackage(proto.package, window);
							package[proto.name] = js2me.classBucket;
							js2me.classBucket = null;
							remain--;
							if (remain == 0) {
								callback(true);
							}
						};
						document.head.appendChild(element);
					})(className);
				}
			}
			if (remain == 0) {
				callback(false);
			}
		}
		function iterateClasses(obj, name, action) {
			action(obj, name);
			for (var i in obj) {
				if (i[0] == '$') {
					iterateClasses(obj[i], name + '.' + i, action);
				}
			}
		}
		function setClassesNames() {
			iterateClasses(javaRoot, js2me.JAVA_ROOT, function (obj, name) {
				if (obj.prototype) {
					obj.prototype.className = name;
				}
			});
		}
		function setClassesPrototypes() {
			iterateClasses(javaRoot, js2me.JAVA_ROOT, function (obj, name) {
				if (obj.prototype) {
					if (!obj.prototype.superClass && obj != javaRoot.$java.$lang.$Object) {
						obj.prototype.superClass = 'javaRoot.$java.$lang.$Object';
					}
					if (obj.prototype.superClass) {
						var superClass = js2me.findClass(obj.prototype.superClass);
						obj.prototype.__proto__ = new superClass();
					}
				}
			});
		}
		function initClasses() {
			iterateClasses(javaRoot, js2me.JAVA_ROOT, function (obj, name) {
				var classObj = js2me.findClass(name);
				js2me.initializeClass(classObj);
			});
		}
		function checkClasses(limit, callback) {
			if (limit == 0) {
				throw new Error('checkClasses problem');
			}
			iterateClasses(javaRoot, js2me.JAVA_ROOT, function (obj) {
				if (obj.prototype) {
					obj.prototype.require = [];
					for (var i in obj.prototype) {
						if (obj.prototype[i] != null && obj.prototype[i].constructor == Function) {
							var source = obj.prototype[i].toString();
							var requirements = source.match(new RegExp('javaRoot(\\.\\$[a-zA-Z]+)+', 'g'));
							for (var j = 0; requirements && j < requirements.length; j++) {
								obj.prototype.require.push(requirements[j]);
							}
						}
					}
					try {
						if (obj.prototype.superClass) {
							js2me.findClass(obj.prototype.superClass);
						}
					} catch (e) {
						js2me.classes[obj.prototype.superClass] = true;
					}
					if (obj.prototype.require) {
						for (var i = 0; i < obj.prototype.require.length; i++) {
							js2me.classes[obj.prototype.require[i]] = true;
						}
					}
				}
			});
			loadClasses(js2me.classes, function (isNewClasses) {
				if (isNewClasses) {
					checkClasses(limit - 1, callback);
				} else {
					callback();
				}
			});
		}
		
		var start = function () {
			checkClasses(10, function () {
				setClassesNames();
				setClassesPrototypes();
				//initClasses();
				var mainMidlet = js2me.manifest['midlet-1'];
				var mainClass = js2me.findClass(js2me.JAVA_ROOT + '.$' + mainMidlet.split(',')[2].trim().replace(/\./g, '.$'));
				var mainThread = new javaRoot.$java.$lang.$Thread(function () {
					js2me.initializeClass(mainClass);
					var midlet = new mainClass();
					midlet._init$$V();
					var startApp = function () {
						js2me.restoreThread();
						if (js2me.suspendThread) {
							js2me.restoreStack[js2me.currentThread].push(startApp);
						} else {
							midlet.$startApp$$V();
						}
					};
					if (!js2me.suspendThread) {
						startApp();
					} else {
						js2me.restoreStack[js2me.currentThread].push(startApp);
					}
				});
				setTimeout(function () {
					mainThread.$start$$V();
				}, 100);
			});
			
		}
		var standardClasses = [
			'javaRoot.$java.$lang.$Object',
			'javaRoot.$java.$lang.$String',
			'javaRoot.$java.$lang.$Thread',
			'javaRoot.$java.$lang.$ClassNotFoundException',
			'javaRoot.$java.$lang.$ClassCastException'
		];
		loadClasses(standardClasses, function () {
			zip.createReader(reader, function(zipReader) {
				zipReader.getEntries(function (entries) {
					js2me.loadEntries(entries, start);
				});
			}); 
		});
		//document.getElementById('keypad').style.width = js2me.width + 'px';
		document.getElementById('screen').style.width = js2me.width + 'px';
		document.getElementById('screen').style.height = js2me.height + 'px';
			
		
	};
	window.onkeydown = function (e) {
		var mapping = [];
		mapping[38] = 'up';
		mapping[37] = 'left';
		mapping[39] = 'right';
		mapping[40] = 'down';
		mapping[32] = 'ok';
		mapping[48] = 'num0';
		mapping[49] = 'num1';
		mapping[50] = 'num2';
		mapping[51] = 'num3';
		mapping[52] = 'num4';
		mapping[53] = 'num5';
		mapping[54] = 'num6';
		mapping[55] = 'num7';
		mapping[56] = 'num8';
		mapping[57] = 'num9';
		//console.log(e.keyCode);
		if (mapping[e.keyCode]) {
			var evt = document.createEvent("MouseEvents");
			evt.initMouseEvent("mousedown", true, true, window);
			var element = document.getElementById(mapping[e.keyCode]);
			element.dispatchEvent(evt);
		}
	};
	var js2me = {
		JAVA_ROOT: 'javaRoot',
		width: 240,
		height: 266,
		resources: {},
		classes: {},
		threads: [],
		currentThread: 0,
		restoreStack: [],
		stats: [],
		kill: false
	};
	for (var i = 0; i < 255; i++) {
		js2me.stats[i] = 0;
	}
</script>

<style>
	#title {
		border: 1px solid black;
		text-align: center;
		height: 14px;
	}
	#keypad {
		text-align: center;
	}
	.key, .softkey {
		display: inline-block;
		border: 1px solid black;
	}
	.key:hover, .softkey:hover {
		background: #aaf
	}
	#up.key, #down.key {
		width: 80px;
		height: 13px;
		
	}
	#left.key, #right.key, #ok.key {
		width: 38px;
		height: 13px;
		
	}
	#choice.softkey, #back.softkey {
		width: 48px;
		height: 18px;
	}
	.num {
		width: 38px;
		height: 13px;
	}
	#frame {
		display: inline-block;
		border: 1px solid black;
		overflow: hidden;
		width: 320px;
		height: 480px;
		text-align: center;
	}
	#screen {
		border: 1px solid black;
		display: inline-block;
	}
	.item {
		text-align: left;
	}
</style>
<div id="frame">
	<div id="title"></div>
	<div id="screen"></div>
	<div id="keypad">
		<a id="up" class="key"></a><br>
		<a id="choice" class="softkey"></a>
		<a id="left" class="key"></a>
		<a id="ok" class="key"></a>
		<a id="right" class="key"></a>
		<a id="back" class="softkey"></a><br>
		<a id="down" class="key"></a><br>
		<a id="num1" class="key num"></a>
		<a id="num2" class="key num"></a>
		<a id="num3" class="key num"></a><br>
		<a id="num4" class="key num"></a>
		<a id="num5" class="key num"></a>
		<a id="num6" class="key num"></a><br>
		<a id="num7" class="key num"></a>
		<a id="num8" class="key num"></a>
		<a id="num9" class="key num"></a><br>
		<a id="star" class="key num"></a>
		<a id="num0" class="key num"></a>
		<a id="pound" class="key num"></a><br>
	</div>
</div>

<script type="text/javascript" src="js/bufferStream.js"></script>
<script type="text/javascript" src="js/convert.js"></script>
<script type="text/javascript" src="js/execute.js"></script>
<script type="text/javascript" src="js/manifest.js"></script>
<script type="text/javascript" src="js/loader.js"></script>
<script type="text/javascript" src="js/numbers.js"></script>
